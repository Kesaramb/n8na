@use 'sass:math';
@use 'sass:meta';

@include meta.load-css('highlight.js/styles/github.css');

@mixin hljs-dark-theme {
	@include meta.load-css('highlight.js/styles/github-dark-dimmed.css');
}

@function toRem($px) {
	@return math.div(math.round(math.div($px, 21.3) * 1000), 1000) + rem;
}

// Light theme colors
$markdown-text-color-light: #000;
$markdown-link-color-light: #7a283a;
$markdown-link-hover-light: hsl(0, 25%, 65%);
$markdown-link-active-light: hsl(0, 25%, 45%);
$markdown-code-bg-light: #e0e6eb;
$markdown-code-color-light: #24292e;
$markdown-blockquote-color-light: #6a737d;
$markdown-blockquote-border-light: #dfe2e5;
$markdown-hr-color-light: rgba(31, 35, 41, 0.15);
$markdown-table-border-light: #d0d7de;
$markdown-table-header-bg-light: #f6f8fa;
$markdown-table-bg-light: #fff;

// Dark theme colors
$markdown-text-color-dark: #e6edf3;
$markdown-link-color-dark: #f85149;
$markdown-link-hover-dark: #ff7b72;
$markdown-link-active-dark: #da3633;
$markdown-code-bg-dark: #151619;
$markdown-code-color-dark: #e6edf3;
$markdown-blockquote-color-dark: #8b949e;
$markdown-blockquote-border-dark: #bbbfc4;
$markdown-hr-color-dark: #444546;
$markdown-table-border-dark: #525455;
$markdown-table-header-bg-dark: rgba(255, 255, 255, 0.25);
$markdown-table-bg-dark: transparent;

// highlight.js colors
$highlight-border-color-light: #d1d9e0;
$highlight-background-color-light: #fff;
$highlight-tool-bar-background-light: #e0e6eb;
$highlight-tool-bar-color-light: #000;
$highlight-tool-bar-border-light: #d1d9e0;
$highlight-border-color-dark: #3d444d;
$highlight-background-color-dark: #151619;
$highlight-tool-bar-background-dark: #151b23;
$highlight-tool-bar-color-dark: #fff;
$highlight-tool-bar-border-dark: #3d444d;

@mixin markdown-dark-theme {
	.chat-message-markdown {
		color: $markdown-text-color-dark;
		a {
			color: $markdown-link-color-dark;

			&:hover {
				color: $markdown-link-hover-dark;
			}
			&:active {
				color: $markdown-link-active-dark;
			}
		}

		hr {
			background: $markdown-hr-color-dark;
		}

		code {
			background: $markdown-code-bg-dark;
			color: $markdown-code-color-dark;
		}

		blockquote {
			color: $markdown-blockquote-color-dark;
			border-left-color: $markdown-blockquote-border-dark;
		}

		table {
			border-left-color: $markdown-table-border-dark;
			border-bottom-color: $markdown-table-border-dark;
			background-color: $markdown-table-bg-dark;

			thead tr {
				background-color: $markdown-table-header-bg-dark;
			}

			th,
			td {
				border-top-color: $markdown-table-border-dark;
				border-right-color: $markdown-table-border-dark;
				padding: toRem(8) toRem(12);
				height: toRem(40);
			}
		}

		.highlight {
			border: toRem(1) solid $highlight-border-color-dark;
			background-color: $highlight-background-color-dark;
			&-tool-bar {
				background: $highlight-tool-bar-background-dark;
				color: $highlight-tool-bar-color-dark;
				border-bottom: 1px solid $highlight-tool-bar-border-dark;
			}

			&-copy-btn {
				background: $highlight-background-color-dark;
				border-color: $highlight-tool-bar-border-dark;
				&:hover {
					background: rgba(255, 255, 255, 0.1);
					border-color: rgba(255, 255, 255, 0.3);
				}
			}

			&.copied {
				.highlight-copy-btn {
					background: rgba(255, 255, 255, 0.1);
					border-color: rgba(255, 255, 255, 0.3);
					color: white;
				}
			}
		}
	}
}

// Apply dark theme
body {
	&[data-theme='dark'] {
		@include markdown-dark-theme;
		@include hljs-dark-theme;
	}

	@media (prefers-color-scheme: dark) {
		@include markdown-dark-theme;
		@include hljs-dark-theme;
	}
}

.chat-message-markdown {
	-ms-text-size-adjust: 100%;
	-webkit-text-size-adjust: 100%;
	margin: 0;
	font-size: toRem(16);
	line-height: 1.5;
	word-wrap: break-word;
	white-space: normal;
	color: $markdown-text-color-light;
	> :first-child {
		margin-top: 0 !important;
	}
	> :last-child {
		margin-bottom: 0 !important;
	}
	h1,
	h2,
	h3,
	h4,
	h5,
	h6,
	p {
		margin-top: toRem(18);
		margin-bottom: toRem(13);
	}

	h1,
	h2,
	h3,
	h4,
	h5,
	h6 {
		font-weight: 600;
	}

	h1 {
		font-size: toRem(27);
		line-height: 1.5;
	}

	h2 {
		font-size: toRem(22);
		line-height: 1.5;
	}

	h3 {
		font-size: toRem(18);
		line-height: 1.5;
	}

	h4 {
		font-size: toRem(16);
		line-height: 1.5;
	}

	h5 {
		font-size: toRem(14);
		line-height: 1.5;
	}

	h6 {
		font-size: toRem(13.6);
		line-height: 1.5;
	}

	p {
		font-size: toRem(16);
		line-height: 1.5;
		font-weight: 400;
	}

	a {
		color: $markdown-link-color-light;
		text-decoration: underline;

		&:hover {
			color: $markdown-link-hover-light;
		}
		&:active {
			color: $markdown-link-active-light;
		}
	}

	hr {
		height: toRem(1);
		margin: toRem(13) 0;
		background: $markdown-hr-color-light;
		border: none;
		display: block;
	}

	code {
		background: $markdown-code-bg-light;
		color: $markdown-code-color-light;
		padding: toRem(4) toRem(8);
		border-radius: toRem(8);
	}

	code,
	kbd,
	pre,
	samp {
		font-family: monospace;
		font-size: toRem(16);
	}

	pre {
		border-radius: toRem(8);
	}

	img {
		max-width: toRem(400);
		max-height: toRem(240);
		max-width: 100%;
		object-fit: contain;
	}
	video {
		max-height: toRem(240);
		max-width: 100%;
		object-fit: cover;
	}

	blockquote {
		margin: 0;
		padding: 0 toRem(16);
		color: $markdown-blockquote-color-light;
		border-left: toRem(4) solid $markdown-blockquote-border-light;
	}

	ul,
	ol {
		margin-top: 0;
		margin-bottom: 0;
		padding-left: toRem(32);
	}

	table {
		border-spacing: 0;
		border-collapse: collapse;
		display: block;
		width: max-content;
		max-width: 100%;
		overflow-x: auto;
		overflow-y: hidden;
		border-left: 1px solid $markdown-table-border-light;
		border-bottom: 1px solid $markdown-table-border-light;
		background-color: $markdown-table-bg-light;

		thead tr {
			background-color: $markdown-table-header-bg-light;
		}

		th,
		td {
			padding: toRem(6) toRem(13);
			border-top: 1px solid $markdown-table-border-light;
			border-right: 1px solid $markdown-table-border-light;
		}
	}
	// MathJax 数学公式样式
	.MathJax {
		display: inline-block !important;
		font-size: inherit !important;
	}

	.MathJax_Display {
		text-align: center;
		margin: toRem(21.3) 0;
	}

	mjx-container {
		display: inline-block;
		margin: auto;

		&[display='block'] {
			display: block;
			text-align: center;
			margin: toRem(21.3) 0;
		}
	}
	.highlight {
		margin: toRem(8) 0;
		min-width: toRem(300);
		min-height: 100%;
		display: block;
		border-radius: toRem(8);
		overflow: hidden;
		border: 1px solid $highlight-border-color-light;
		background-color: $highlight-background-color-light;
		overflow: hidden;

		&-tool-bar {
			color: $highlight-tool-bar-color-light;
			background: $highlight-tool-bar-background-light;
			font-size: toRem(16);
			padding: toRem(8) toRem(12);
			border-bottom: 1px solid #d1d9e0;
			display: flex;
			align-items: center;
			justify-content: space-between;
		}
		&-language {
			text-transform: lowercase;
		}
		&-code-box {
			background: #fff;
			padding: toRem(8);
			border-radius: 0;
			overflow-x: auto;
		}
		&-copy-btn {
			display: flex;
			align-items: center;
			cursor: pointer;
			padding: toRem(4) toRem(8);
			border: 1px solid transparent;
			border-radius: toRem(8);
			background: $highlight-background-color-light;
			border-color: $highlight-tool-bar-border-light;
			color: inherit;
			transition: all 0.2s ease;
			font-size: toRem(16);
			&:hover {
				background: rgba(0, 0, 0, 0.1);
				border-color: rgba(0, 0, 0, 0.15);
			}
		}
		&-copied-text {
			margin-left: toRem(4);
			display: none;
		}
		&.copied {
			.highlight-copy-btn {
				background: rgba(0, 0, 0, 0.1);
				border-color: rgba(0, 0, 0, 0.15);
			}

			.highlight-copy-text {
				display: none;
			}
			.highlight-copied-text {
				display: flex;
			}
		}
		&-copy-text {
			margin-left: toRem(4);
		}

		.task-list-item {
			list-style-type: none;

			label {
				font-weight: 400;
			}

			&.enabled label {
				cursor: pointer;
			}

			& + .task-list-item {
				margin-top: toRem(4);
			}

			.handle {
				display: none;
			}

			.task-list-item-checkbox {
				margin: 0 toRem(3.2) toRem(4) toRem(-22.4);
				vertical-align: middle;
			}
		}

		.contains-task-list {
			position: relative;

			&:dir(rtl) .task-list-item-checkbox {
				margin: 0 toRem(-25.6) toRem(4) toRem(3.2);
			}

			&:hover .task-list-item-convert-container,
			&:focus-within .task-list-item-convert-container {
				display: block;
				width: auto;
				height: toRem(24);
				overflow: visible;
				clip: auto;
			}
		}
	}
}
