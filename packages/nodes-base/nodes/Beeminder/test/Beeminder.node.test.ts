import { NodeTestHarness } from '@nodes-testing/node-test-harness';
import type { WorkflowTestData } from 'n8n-workflow';
import nock from 'nock';

const newGoal = {
	slug: 'test3333',
	title: 'test title',
	description: null,
	goalval: 1000,
	rate: 1,
	goaldate: null,
	svg_url: null,
	graph_url: 'https://cdn.beeminder.com/default_large_graph.png',
	thumb_url: 'https://cdn.beeminder.com/default_thumb_graph.png',
	goal_type: 'hustler',
	autodata: null,
	healthkitmetric: '',
	autodata_config: {},
	losedate: 1753990654,
	urgencykey: 'FROx;PPRx;DL0000000000;P1000000000;test3333',
	deadline: -43260,
	leadtime: 0,
	alertstart: 34200,
	use_defaults: true,
	id: '688bc5fdf0168a11bee2468f',
	ephem: false,
	queued: true,
	panic: 54000,
	updated_at: 1753990654,
	burner: 'frontburner',
	yaw: 1,
	lane: null,
	delta: null,
	runits: 'w',
	limsum: null,
	frozen: false,
	lost: false,
	won: false,
	contract: {
		amount: 0,
		stepdown_at: null,
		pending_amount: null,
		pending_at: null,
	},
	delta_text: null,
	safebuf: null,
	safebump: null,
	safesum: 'safe for  day',
	autoratchet: null,
	coasting: null,
	limsumdate: ' due Thu by 21:37',
	limsumdays: ' due by 21:37',
	baremin: null,
	baremintotal: null,
	roadstatuscolor: '',
	lasttouch: null,
	integery: false,
	fineprint: null,
	todayta: true,
	hhmmformat: false,
	gunits: 'unit',
	weekends_off: false,
	yaxis: 'cumulative total unit',
	maxflux: null,
	tmin: null,
	tmax: null,
	initday: null,
	initval: null,
	curday: null,
	curval: null,
	currate: null,
	lastday: null,
	dir: 1,
	kyoom: true,
	odom: false,
	noisy: false,
	aggday: 'sum',
	plotall: true,
	steppy: true,
	rosy: false,
	movingav: false,
	aura: false,
	numpts: 1,
	road: [],
	roadall: [
		[1754020800, 0, null],
		[null, 1000, 1],
	],
	fullroad: null,
	secret: true,
	pledge: 0,
	pledge_cap: 30,
	mathishard: null,
	headsum: null,
	datapublic: false,
	graphsum: null,
	rah: null,
	last_datapoint: {
		id: '688bc5fef0168a11bee24691',
		timestamp: 1754042339,
		daystamp: '20250801',
		value: 0,
		comment: 'initial datapoint of 0 on the 1st',
		updated_at: 1753990654,
		requestid: null,
		origin: 'nihilo',
		creator: '',
		is_dummy: false,
		is_initial: true,
		urtext: null,
		fulltext: '2025-Aug-01 entered at 21:37 on 2025-Jul-31 ex nihilo',
		canonical: '01 0 "initial datapoint of 0 on the 1st"',
		created_at: '2025-07-31T19:37:34.000Z',
	},
	callback_url: null,
	tags: [],
	recent_data: [
		{
			id: '688bc5fef0168a11bee24691',
			timestamp: 1754042339,
			daystamp: '20250801',
			value: 0,
			comment: 'initial datapoint of 0 on the 1st',
			updated_at: 1753990654,
			requestid: null,
			origin: 'nihilo',
			creator: '',
			is_dummy: false,
			is_initial: true,
			urtext: null,
			fulltext: '2025-Aug-01 entered at 21:37 on 2025-Jul-31 ex nihilo',
			canonical: '01 0 "initial datapoint of 0 on the 1st"',
			created_at: '2025-07-31T19:37:34.000Z',
		},
	],
	dueby: null,
};

describe('Execute Beeminder Node', () => {
	const testHarness = new NodeTestHarness();

	beforeEach(() => {
		nock('https://beeminder.com').post('/api/v1/users/me/goals.json').reply(200, newGoal);
	});

	const testData: WorkflowTestData = {
		description: 'Execute operations',
		input: {
			workflowData: testHarness.readWorkflowJSON('workflow.json'),
		},
		output: {
			nodeData: {
				'Create a new goal': [[{ json: newGoal }]],
			},
		},
	};

	testHarness.setupTest(testData, { credentials: { beeminderApi: {} } });
});
